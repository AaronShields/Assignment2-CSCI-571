<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Search</title>
    <link rel="stylesheet" href="weather.css"> 
</head>
<body>

    <div class="form-container">
        <div class="banner">
            <img src="images/banner.jpg" alt="Cloud Banner">
            <div class="banner-text">
                Weather Search
            </div>
        </div>
        <form class="weatherform" id="weatherForm">
            <label for="street">Street</label>
            <input type="text" id="street" name="street">

            <div class="city-state-container">
                <div class="city-state">
                    <label for="city">City</label>
                    <input type="text" id="city" name="city">
                </div>
                <div class="city-state">
                    <label for="state">State</label>
                    <select id="state" name="state">
                        <option value="">Select State</option>
                        <option value="CA">California</option>
                        <option value="NY">New York</option>
                    </select>
                </div>
            </div>
            <hr>
            <label for="auto-detect">
                <input type="checkbox" id="auto-detect" name="auto-detect">
                Check here to use your current location
            </label>
            <div class="buttons">
                <button type="button" onclick="submitForm()">Submit</button>
                <button type="button" onclick="clearForm()">Clear</button>
            </div>
        </form>

    </div>

    <div id="results" class="results">
        <!-- How can i show results here  -->
    </div>

    <script>
        function submitForm() {
            const autoDetect = document.getElementById("auto-detect").checked;
            const street = document.getElementById("street").value;
            const city = document.getElementById("city").value;
            const state = document.getElementById("state").value;

            if (!autoDetect && (!street || !city || !state)) {
                alert("Please fill all the fields or check the auto-detect option.");
                return;
            }

            if (autoDetect) {
                fetch("https://ipinfo.io?token=YOUR_IPINFO_TOKEN")  
                    .then(response => response.json())
                    .then(data => {
                        const location = `${data.city}, ${data.region}, ${data.country}`;
                        displayResults(`Auto-detected location: ${location}`);
                        sendToServer(data.city, data.region, data.country);  
                    })
                    .catch(error => {
                        console.error("Error fetching location:", error);
                        displayResults("Error detecting location.");
                    });
            } else {
                sendToServer(street, city, state);  
            }
        }

        function clearForm() {
            document.getElementById("weatherForm").reset();
            document.getElementById("results").innerHTML = "";
        }

        function displayResults(message) {
            document.getElementById("results").innerHTML = `<p>${message}</p>`;
        }

        function sendToServer(street, city, state) {
            const apiKey = 'AIzaSyD5fCf4IpcurNZal3VYv2UUwOO_kbSnmtY'; 
            const address = `${street}, ${city}, ${state}`;
            const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;

          
            fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        const location = data.results[0].geometry.location;
                        const lat = location.lat;
                        const lng = location.lng;
                        displayResults('Latitude and Longitude:', lat, lng);

                        fetch(`/weather?lat=${lat}&lng=${lng}`)
                            .then(response => response.json())
                            .then(weatherData => {
                                displayResults(`Weather data: ${JSON.stringify(weatherData)}`);
                            })
                            .catch(error => {
                                console.error("Error fetching weather data:", error);
                                displayResults("Error fetching weather data.", lat); 
                            });
                    } else {
                        displayResults("Geocoding failed. Please check the address.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching geocoding data:", error);
                    displayResults("Error fetching geocoding data.");
                });
        }
    </script>

</body>
</html>